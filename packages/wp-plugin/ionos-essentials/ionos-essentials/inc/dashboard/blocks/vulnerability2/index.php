<?php

namespace ionos\essentials\dashboard\blocks\vulnerability2;

defined('ABSPATH') || exit();

function render_callback(): void
{
  $args   = [
    'high'       => count(\ionos\essentials\wpscan\get_wpscan()->get_issues('critical')),
    'medium'     => count(\ionos\essentials\wpscan\get_wpscan()->get_issues('warning')),
    'last_scan'  => \ionos\essentials\wpscan\get_wpscan()
      ->get_lastscan(),
  ];

  $error = \ionos\essentials\wpscan\get_wpscan()
    ->get_error();

  $class = ($args['high'] > 0) ? 'high' : ($args['medium'] > 0 ? 'medium' : '');
  $class = ($error) ? 'error' : $class;

  ?>
  <div class="card ionos_vulnerability2 <?php echo \esc_attr($class); ?>">
    <div class="card__content">
      <section class="card__section">
        <h4 class="headline headline--sub"><?php \esc_html_e('Vulnerability2 Scan', 'ionos-essentials'); ?></h4>

      <div class="ionos_vulnerability2__content" style="display: flex;">
        <?php
        if ($error) {
          printf('<p class="ionos_vulnerability2__error">%s</p>', \esc_html($error));
        } else {
          display_problems($args);
          // display_full_report_link($args);
          display_last_scan($args);
        }
  ?>
      </div>
      </section>

    </div>
  </div>

<?php
}

function display_problems(array $args): void
{

  echo '<div class="ionos_vulnerability2__problems">';

  if (0 < $args['high']) {
    echo '<div class="issue-row2 high">';
    echo '<span class="bubble">' . \esc_html($args['high']) . '</span>' . \esc_html(
      _n('critical issue found', 'critical issues found', $args['high'], 'ionos-essentials')
    );
    echo '</div>';
  }
  if (0 < $args['medium']) {
    echo '<div class="issue-row2 medium">';
    echo '<span class="bubble">' . \esc_html($args['medium']) . '</span>' . \esc_html(
      _n('warning found', 'warnings found', $args['medium'], 'ionos-essentials')
    );
    echo '</div>';
  }

  if (0 === $args['high'] && 0 === $args['medium']) {
    echo '<div class="issue-row2 none">';
    echo '<span class="bubble"><i class="exos-icon exos-icon-check-16"></i></span><h4 class="headline headline--sub">' . \esc_html__('Website is safe and secure', 'ionos-essentials');
    echo '</h4></div>';
  }
  echo '</div>';
}

// function display_full_report_link($args): void
// {
//   printf(
//     <<<EOF
//     <div class="ionos_vulnerability2__report-link">
//       <a href="#tools" class="button button--secondary">%s</a>
//     </div>
// EOF
//     ,
//     \esc_html__('Show full scan report', 'ionos-essentials')
//   );
// }

function display_last_scan(array $args): void
{
  (! $args['last_scan']) ? \esc_html_e('No scan has been performed yet.', 'ionos-essentials') : printf(
    // translators: %s is placeholder for the time since the last scan
    \esc_html__('Last scan ran %s ago', 'ionos-essentials'),
    $args['last_scan']
  );
}
