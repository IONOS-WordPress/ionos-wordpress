<?php

namespace ionos\essentials\dashboard\blocks\vulnerability;

defined('ABSPATH') || exit();
use const ionos\essentials\PLUGIN_FILE;

function render_callback(): void
{
  $args   = [
    'high'       => count(\ionos\essentials\wpscan\get_wpscan()->get_issues('critical')),
    'medium'     => count(\ionos\essentials\wpscan\get_wpscan()->get_issues('warning')),
    'last_scan'  => \ionos\essentials\wpscan\get_wpscan()
      ->get_lastscan(),
  ];

  $error = \ionos\essentials\wpscan\get_wpscan()
    ->get_error();

  $class = ($args['high'] > 0) ? 'high' : ($args['medium'] > 0 ? 'medium' : '');
  $class = ($error) ? 'error' : $class;

  ?>
  <div class="card ionos_vulnerability <?php echo \esc_attr($class); ?>">
    <div class="card__content">
      <section class="card__section">
        <h4 class="headline headline--sub ionos_vulnerability__headline"><?php \esc_html_e('Vulnerability scan', 'ionos-essentials'); ?></h4>
        <div class="ionos_vulnerability__content" style="display: flex;">
          <?php
          if ($error) {
            printf('<p class="ionos_vulnerability__error">%s</p>', \esc_html($error));
          } else {
            display_problems($args);
            display_last_scan($args);
          }
  ?>
        </div>
      </section>
    </div>
  </div>

<?php
}

function display_problems(array $args): void
{

  echo '<div class="ionos_vulnerability__problems">';

  if (0 < $args['high'] || 0 < $args['medium']) {
    echo '<div class="issue-rows">';

    if (0 < $args['high']) {
      echo '<div class="issue-row high">';
      echo '<span class="bubble">' . \esc_html($args['high']) . '</span>' . \esc_html(
        _n('critical issue found', 'critical issues found', $args['high'], 'ionos-essentials')
      );
      echo '</div>';
    }
    if (0 < $args['medium']) {
      echo '<div class="issue-row medium">';
      echo '<span class="bubble">' . \esc_html($args['medium']) . '</span>' . \esc_html(
        _n('warning found', 'warnings found', $args['medium'], 'ionos-essentials')
      );
      echo '</div>';
    }
    echo '</div>';

    display_full_report_link($args);
  }

  if (0 === $args['high'] && 0 === $args['medium']) {
    echo '<div class="issue-row none">';
    echo '<span class="bubble">';
    echo '<svg class="icon-done" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 20 20"><circle cx="10" cy="10" r="10" fill="#4caf50" /><path fill="#ffffff" d="M13.6,6.0 L8.48,11.18 L6.4,9.09 L5.0,10.5 L8.48,14.0 L15.0,7.4 L13.6,6.0 Z" /></svg>';
    echo '</span>';
    echo '<h4 class="headline headline--sub">';
    echo \esc_html__('Website is safe and secure', 'ionos-essentials');
    echo '</h4></div>';
  }
  echo '</div>';
}

function display_full_report_link($args): void
{
  printf(
    <<<EOF
    <div class="ionos_vulnerability__report-link">
      <a href="#tools" class="button button--secondary">%s</a>
    </div>
EOF
    ,
    \esc_html__('View details', 'ionos-essentials')
  );
}

function display_last_scan(array $args): void
{
  echo '<p class="ionos_vulnerability__last-scan">';
  (! $args['last_scan']) ? \esc_html_e('No scan has been performed yet.', 'ionos-essentials') : printf(
    // translators: %s is placeholder for the time since the last scan
    \esc_html__('Last scan ran %s ago', 'ionos-essentials'),
    $args['last_scan']
  );
  echo '</p>';
}
