<?php

namespace ionos\essentials\dashboard\blocks\vulnerability;

defined('ABSPATH') || exit();

function render_callback(): void
{
  $args = [
    'high'      => count(\ionos\essentials\wpscan\get_wpscan()->get_issues('critical')),
    'medium'    => count(\ionos\essentials\wpscan\get_wpscan()->get_issues('warning')),
    'last_scan' => \ionos\essentials\wpscan\get_wpscan()
      ->get_lastscan(),
  ];

  $error = \ionos\essentials\wpscan\get_wpscan()
    ->get_error();

  $class = ($args['high'] > 0) ? 'high' : ($args['medium'] > 0 ? 'medium' : '');
  $class = ($error) ? 'error' : $class;

  $class_attr    = \esc_attr($class);
  $headline_text = \esc_html__('Vulnerability scan', 'ionos-essentials');

  ob_start();
  if ($error) {
    $error_escaped = \esc_html($error);
    printf('<p class="ionos_vulnerability__error">%s</p>', $error_escaped);
  } else {
    display_problems($args);
    display_last_scan($args);
  }
  $content = ob_get_clean();

  printf(
    <<<EOF
    <div class="card ionos_vulnerability {$class_attr}">
      <div class="card__content">
        <section class="card__section">
          <h4 class="headline headline--sub ionos_vulnerability__headline">{$headline_text}</h4>
          <div class="ionos_vulnerability__content" style="display: flex;">
            %s
          </div>
        </section>
      </div>
    </div>
    EOF
    ,
    $content
  );
}

function display_problems(array $args): void
{
  $issue_rows = '';

  if (0 < $args['high'] || 0 < $args['medium']) {
    $high_row   = '';
    $medium_row = '';

    if (0 < $args['high']) {
      $high_count = \esc_html($args['high']);
      $high_text  = \esc_html(\_n('critical issue found', 'critical issues found', $args['high'], 'ionos-essentials'));
      $high_row   = sprintf(
        <<<EOF
        <div class="issue-row high">
          <span class="bubble">%s</span>%s
        </div>
        EOF
        ,
        $high_count,
        $high_text
      );
    }

    if (0 < $args['medium']) {
      $medium_count = \esc_html($args['medium']);
      $medium_text  = \esc_html(\_n('warning found', 'warnings found', $args['medium'], 'ionos-essentials'));
      $medium_row   = sprintf(
        <<<EOF
        <div class="issue-row medium">
          <span class="bubble">%s</span>%s
        </div>
        EOF
        ,
        $medium_count,
        $medium_text
      );
    }

    ob_start();
    display_full_report_link($args);
    $report_link = ob_get_clean();

    $issue_rows = sprintf(
      <<<EOF
      <div class="issue-rows">
        %s
        %s
      </div>
      %s
      EOF
      ,
      $high_row,
      $medium_row,
      $report_link
    );
  }

  if (0 === $args['high'] && 0 === $args['medium']) {
    $safe_text  = \esc_html__('Website is safe and secure', 'ionos-essentials');
    $issue_rows = <<<EOF
    <div class="issue-row none">
      <span class="bubble">
        <svg class="icon-done" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 20 20"><circle cx="10" cy="10" r="10" fill="#4caf50" /><path fill="#ffffff" d="M13.6,6.0 L8.48,11.18 L6.4,9.09 L5.0,10.5 L8.48,14.0 L15.0,7.4 L13.6,6.0 Z" /></svg>
      </span>
      <h4 class="headline headline--sub">{$safe_text}</h4>
    </div>
    EOF;
  }

  printf(<<<EOF
    <div class="ionos_vulnerability__problems">
      %s
    </div>
    EOF
    , $issue_rows);
}

function display_full_report_link($args): void
{
  printf(
    <<<EOF
    <div class="ionos_vulnerability__report-link">
      <a href="#tools" class="button button--secondary">%s</a>
    </div>
    EOF
    ,
    \esc_html__('View details', 'ionos-essentials')
  );
}

function display_last_scan(array $args): void
{
  if (! $args['last_scan']) {
    $scan_text = \esc_html__('No scan has been performed yet.', 'ionos-essentials');
  } else {
    $last_scan = \esc_html($args['last_scan']);
    // translators: %s is placeholder for the time since the last scan
    $scan_text = sprintf(\esc_html__('Last scan ran %s ago', 'ionos-essentials'), $last_scan);
  }

  printf('<p class="ionos_vulnerability__last-scan">{$scan_text}');
}
