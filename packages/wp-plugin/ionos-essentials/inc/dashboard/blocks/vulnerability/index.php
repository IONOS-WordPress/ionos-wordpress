<?php

namespace ionos\essentials\dashboard\blocks\vulnerability;

function render_callback(): void
{
  $args   = [
    'high'       => count(\ionos\essentials\wpscan\get_wpscan()->get_issues('critical')),
    'medium'     => count(\ionos\essentials\wpscan\get_wpscan()->get_issues('warning')),
    'last_scan'  => \ionos\essentials\wpscan\get_wpscan()
      ->get_lastscan(),
  ];

  $error = \ionos\essentials\wpscan\get_wpscan()
    ->get_error();

  $class = ($args['high'] > 0) ? 'high' : ($args['medium'] > 0 ? 'medium' : '');
  $class = ($error) ? 'error' : $class;

  ?>
  <div class="card ionos_vulnerability <?php echo \esc_attr($class); ?>">
    <div class="card__content">
      <section class="card__section">
        <h2 class="headline headline--sub"><?php echo \esc_html__('Scan for WordPress specific threats and vulnerabilities', 'ionos-essentials'); ?></h2>

      <div class="ionos_vulnerability__content" style="display: flex;">
        <?php
        if ($error) {
          printf('<p class="ionos_vulnerability__error">%s</p>', \esc_html($error));
        } else {
          display_problems($args);
          display_full_report_link($args);
          display_last_scan($args);
        }
  ?>
      </div>
      </section>

    </div>
  </div>

<?php
}

function display_problems($args)
{

  echo '<p class="ionos_vulnerability__problems">';

  if (0 < $args['high']) {
    echo '<div class="issue-row high">';
    echo '<span class="bubble">' . \esc_html($args['high']) . '</span>' . \esc_html(
      _n('critical issue found', 'critical issues found', $args['high'], 'ionos-essentials')
    );
    echo '</div>';
  }
  if (0 < $args['medium']) {
    echo '<div class="issue-row medium">';
    echo '<span class="bubble">' . \esc_html($args['medium']) . '</span>' . \esc_html(
      _n('warning found', 'warnings found', $args['medium'], 'ionos-essentials')
    );
    echo '</div>';
  }

  if (0 === $args['high'] && 0 === $args['medium']) {
    echo '<div class="issue-row none">';
    echo '<span class="bubble">0</span>' . \esc_html__('Issues found', 'ionos-essentials');
    echo '</div>';
  }
  echo '</p>';
}

function display_full_report_link($args)
{
  echo '<div class="ionos_vulnerability__report-link">';
  printf(
    '<a href="#tools" class="button button--secondary">%s</a>',
    \esc_html__('Show full scan report', 'ionos-essentials')
  );
  echo '</div>';
}

function display_last_scan($args)
{
  echo (! $args['last_scan']) ? \esc_html('No scan has been performed yet.', 'ionos-essentials') : \esc_html(
    sprintf('Last scan ran %s ago', $args['last_scan'])
  );
}
