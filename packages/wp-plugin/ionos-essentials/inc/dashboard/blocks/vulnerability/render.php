<?php

namespace ionos\essentials\dashboard\blocks\vulnerability;

use Ionos\Security\Controllers\WPScan;

// Only for testing purposes
if (defined('IONOS_WP_ENV_MODE') && IONOS_WP_ENV_MODE === 'test' && ! class_exists(
  'Ionos\Security\Controllers\WPScan'
)) {
  require_once __DIR__ . '/class-wpscan.php';
  \update_option(WPScan::AUTH_TOKEN_OPTION, 'test_data');
}

function render_callback(): void
{
  $wpscan = WPScan::get_instance();
  $args   = $wpscan->dashboard_widget_content(0);

  ?>
  <div class="card ionos_vulnerability <?php echo \esc_attr(
    0 < $args['high'] ? 'high' : ''
  ); ?> <?php echo \esc_attr(0 < $args['medium'] ? 'medium' : ''); ?>">
    <div class="card__content">
      <section class="card__section">
        <h2 class="card__headline"><?php echo \esc_html__('Scan for WordPress specific threats and vulnerabilities', 'ionos-essentials'); ?></h2>

      <div class="ionos_vulnerability__content">
        <?php display_problems($args); ?>
        <?php display_last_scan($args); ?>
        <?php display_full_report_link($args); ?>
      </div>
      </section>

    </div>
  </div>

<?php
}

function display_problems($args)
{

  echo '<p class="ionos_vulnerability__problems">';

  if (0 < $args['high']) {
    echo '<div class="issue-row high">';
    echo '<span class="bubble">' . \esc_html($args['high']) . '</span>' . \esc_html(
      _n('critical issue found', 'critical issues found', $args['high'], 'ionos-essentials')
    );
    echo '</div>';
  }
  if (0 < $args['medium']) {
    echo '<div class="issue-row medium">';
    echo '<span class="bubble">' . \esc_html($args['medium']) . '</span>' . \esc_html(
      _n('warning found', 'warnings found', $args['medium'], 'ionos-essentials')
    );
    echo '</div>';
  }

  if (0 === $args['high'] && 0 === $args['medium']) {
    echo '<div class="issue-row none">';
    echo '<span class="bubble">0</span>' . \esc_html__('Issues found', 'ionos-essentials');
    echo '</div>';
  }
  echo '</p>';
}

function display_full_report_link($args)
{
  echo '<div class="ionos_vulnerability__report-link mt-5">';
  printf(
    '<a href="%s" class="button button--primary">%s</a>',
    \esc_attr($args['report_url']),
    \esc_html__('Show full scan report', 'ionos-essentials')
  );
  echo '</div>';
}

function display_last_scan($args)
{
  echo \esc_html__('Last scan', 'ionos-essentials');
  echo ': ';
  printf(
    // translators: %s is replaced with the time since the last scan
    \esc_html__('%s ago', 'ionos-essentials'),
    \esc_attr($args['last_scan'])
  );
}
