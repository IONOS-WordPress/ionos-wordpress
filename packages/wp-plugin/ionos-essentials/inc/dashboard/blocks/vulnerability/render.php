<?php

use Ionos\Security\Controllers\WPScan;

// Only for testing purposes
if (defined('IONOS_WP_ENV_MODE') && IONOS_WP_ENV_MODE === 'test' && ! class_exists(
  'Ionos\Security\Controllers\WPScan'
)) {
  require_once __DIR__ . '/class-wpscan.php';
  \update_option(WPScan::AUTH_TOKEN_OPTION, 'test_data');
}

if (class_exists('Ionos\Security\Controllers\WPScan') && \get_option(WPScan::AUTH_TOKEN_OPTION, false)) {
  $wpscan = WPScan::get_instance();
  $args   = $wpscan->dashboard_widget_content(0);

  printf('<div class="wp-block-column vulnerability-block %s">', \esc_attr($args['css_class']));

  echo '<h3 class="wp-block-heading">Vulnerability Scan</h3>';

  printf(
    '<div class="wp-block-group %s content" style="padding-top:0;padding-right:0;padding-bottom:0;padding-left:0">',
    \esc_attr($args['css_class'])
  );
  printf(
    '<div class="wp-block-group %s issue-rows" style="padding-top:0;padding-right:0;padding-bottom:0;padding-left:0">',
    \esc_attr($args['css_class'])
  );
  if (0 < $args['high']) {
    echo '<div class="issue-row high">';
    printf('<p class="dot">%s</p>', \esc_html($args['high']));
    printf(
      '<p>%s</p>',
      \esc_html(_n('critical issue found', 'critical issues found', $args['high'], 'ionos-essentials'))
    );
    echo '</div>';
  }
  if (0 < $args['medium']) {
    echo '<div class="issue-row medium">';
    printf('<p class="dot">%s</p>', \esc_html($args['medium']));
    printf('<p>%s</p>', \esc_html(_n('warning found', 'warnings found', $args['medium'], 'ionos-essentials')));
    echo '</div>';
  }

  if (0 === $args['high'] && 0 === $args['medium']) {
    echo '<div class="issue-row none">';
    printf('<p class="dot">%s</p>', \esc_html('0'));
    printf('<p>%s</p>', \esc_html__('issues found', 'ionos-essentials'));
    echo '</div>';
  }

  echo '<p class="last-scan">';
  echo \esc_html__('Last scan', 'ionos-essentials');
  echo ': ';
  printf(
    // translators: %s is replaced with the time since the last scan
    \esc_html__('%s ago', 'ionos-essentials'),
    \esc_attr($args['last_scan'])
  );
  echo '</p>
    </div>';
  printf(
    '<figure class="wp-block-image is-resized %s" style="margin-top:0;margin-right:0;margin-bottom:0;margin-left:0"><img style="aspect-ratio:1;object-fit:cover;width:96px" src="%s.svg" alt="%s"/></figure>',
    \esc_attr($args['css_class']),
    \esc_attr($args['img_url']) . \esc_attr($args['css_class']),
    \esc_attr($args['css_class'])
  );
  echo '</div>
  <div class="wp-block-buttons">
    <div class="wp-block-button">';
  printf(
    '<a class="wp-block-button__link wp-element-button" href="%s">%s</a>',
    \esc_attr($args['report_url']),
    \esc_html__('Show full scan report', 'ionos-essentials')
  );
  echo '</div>
  </div>
</div>
';

} else {
  printf('<h4>%s</h4>', \esc_html__('WPScan not available', 'ionos-essentials'));
}
